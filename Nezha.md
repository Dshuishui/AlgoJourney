# Nezha: 键值分离的分布式存储系统介绍

## 核心问题

我们发现，现有的分布式键值存储系统中存在一个严重的**冗余数据持久化问题**，这已经成为现代硬件环境下的性能瓶颈：

在基于 Raft 共识协议和 LSM-tree 存储引擎的分布式键值存储系统中，每次数据写入操作至少需要执行**三次不同的磁盘写入操作**：
1. **Raft 日志持久化**：为保证共识协议的安全性
2. **WAL 写入**：LSM-tree 存储引擎的预写日志 
3. **MemTable 持久化**：当 MemTable 达到容量阈值时刷入磁盘

此外，LSM-tree 的后台压缩过程会持续合并和重写多个层级的数据，进一步增加磁盘写入开销。虽然这些冗余的写入操作确保了数据持久性，但我们的分析表明，如此全面的持久化操作对所有数据来说并非总是必要的，这为性能优化提供了机会。

## 解决方案

基于这一发现，我们设计了 **Nezha**, 一个创新的分布式键值存储系统，通过架构创新实现了全面的性能提升。

## 技术创新

我们的主要贡献包括三个方面：

### 1. KVS-Raft 算法

我们设计了一个专门优化的共识算法，在 Raft 中集成键值分离策略。**键值分离的核心特征是将键和位置指针（远小于实际值）存储在数据库中，而将实际值保存在独立的日志文件 ValueLog 中**。这种设计显著降低了存储引擎管理的数据量，**有效缓解了写放大问题**。

具体来说，在 KVS-Raft 中，Raft 日志中只存储轻量级的偏移量，而不是完整的大数据值，从而显著减少写放大。

### 2. Raft 感知的垃圾回收框架

#### 键值分离带来的挑战

虽然键值分离技术大幅提升了写性能，但也引入了三个关键挑战：

**第一个问题：读放大问题**  
键值分离导致读取数据时需要根据偏移量重新构造键值对，产生额外的 I/O 开销，导致读性能下降。**尤其是范围查询时，原本可以根据 key 进行顺序读取的操作，也变为随机读取了，因为需要一个一个找到偏移量，再根据偏移量去索引对应的 value**。

**第二个问题：无效数据累积**  
随着时间推移，ValueLog 中会产生大量无效数据（被更新或删除的旧版本），必须通过垃圾回收 (GC) 来清理。

**第三个问题：安全性约束冲突**  
传统的 GC 机制无法直接应用于分布式共识环境，原因在于：**Raft 要求维持日志的顺序性和完整性来确保数据一致性，而传统键值存储系统中的 GC 机制 <sup>[1]</sup> 可能会破坏这些基本属性**。

#### 我们的创新解决方案

针对这些挑战，我们设计了一个 **Raft 感知的自适应 GC 框架**，创新性地**将 GC 过程与 Raft 的日志管理深度集成**。

**系统可用性保障**：为了确保在 GC 期间系统能够**不间断地对外界提供服务**，在维护强一致性的同时保证系统可用性，我们将 GC 过程划分为三个阶段：Pre-GC、During-GC 和 Post-GC，通过精细的阶段管理确保用户请求在任何时候都能得到正确处理。

**性能优化特性**：该框架能够精确控制 GC 触发时机，将散乱的有效数据重新组织为顺序磁盘文件，并构建高效的索引结构来加速数据访问，从而解决读放大问题。

### 3. 跨层协同优化

不同于现有工作只在单一层面优化，我们从共识层到存储层进行了全面的架构重新设计：

**与经典 WiscKey <sup>[1]</sup> 的对比**：经典的 WiscKey 工作虽然在 LSM-tree 层面实现了键值分离，但当这种思想应用到分布式环境时，仍然存在冗余的数据持久化问题。在分布式系统中，WiscKey 仍需要在共识层、存储层分别进行数据持久化，无法从根本上解决冗余写入的问题。

**我们的优势**：通过将键值分离直接集成到 Raft 共识协议中，实现了比 WiscKey 更彻底的优化——将数据持久化次数从至少 3 次减少到仅 1 次，同时在整个分布式集群范围内消除了存储冗余。

## 性能效果

实验结果显示，相比传统的基于 Raft 的存储系统，Nezha 在写操作、读操作和扫描操作上分别实现了 **445.8%、12.5%和72.6%** 的平均吞吐量提升。相比企业级系统 TiKV，Nezha 平均吞吐量提升了 **209.3%**。

---



[1]: Lanyue Lu, Thanumalayan Sankaranarayana Pillai, Hariharan Gopalakrishnan, Andrea C. Arpaci-Dusseau, and Remzi H. Arpaci-Dusseau. 2017. WiscKey: Separating Keys from Values in SSD-Conscious Storage. ACM Trans. Storage 13, 1, Article 5 (February 2017), 28 pages. https://doi.org/10.1145/3033273